<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title >å¦å¦‚çš„ç”Ÿæ—¥ç¦®ç‰©App</title>
    <style>
        :root {
            /* --- ğŸ¨ ä¸»é¡Œé…è‰²ï¼šç°ç™½æ¥µç°¡é¢¨ --- */
            --primary: #4a4a4a;        
            --primary-light: #7a7a7a;  
            --bg: #f4f4f6;             
            --card-bg: #ffffff;        
            --text: #1d1d1f;           
            --text-sub: #86868b;       
            --nav-height: 70px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        #app-interface {
            /* ä¿®æ­£ 1: ç§»é™¤ CSS é è¨­çš„ display: flex; é¿å…å’Œ JS è¡çªï¼Œè®“ JS å®Œå…¨æ§åˆ¶ */
            flex-direction: column;
            height: 100vh;
        }

        /* --- Header / App Container / å°èˆª... (æ¨£å¼èˆ‡ V5.0 ç›¸åŒ) --- */
        header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 15px 20px; border-bottom: 1px solid #e5e5e5; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .header-title { font-size: 1.1rem; font-weight: 600; letter-spacing: 0.5px; }
        .points-box { background: var(--primary); color: white; padding: 6px 16px; border-radius: 30px; font-weight: 600; font-size: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        #app-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: calc(var(--nav-height) + 20px); }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; flex-direction: column; transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .card-img-box { width: 100%; height: 120px; background: #eee; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-emoji { font-size: 3.5rem; } 
        .card-body { padding: 12px; display: flex; flex-direction: column; flex: 1; justify-content: space-between; }
        .card-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; }
        .card-price { color: var(--text-sub); font-size: 0.9rem; margin-bottom: 10px; min-height: 20px; }
        .price-random { color: #d35400; font-weight: 600; }
        .buy-btn { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 8px; width: 100%; font-size: 0.9rem; font-weight: 500; cursor: pointer; }
        .buy-btn:disabled { background: #e0e0e0; color: #999; }
        .game-area { text-align: center; background: white; border-radius: 20px; padding: 30px 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .spin-btn { background: var(--primary); color: white; border: none; padding: 12px 40px; border-radius: 50px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); cursor: pointer; margin-top: 20px; }
        .game-desc { margin-bottom: 20px; color: var(--text-sub); }
        .inventory-item { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid #eee; }
        .inv-thumb { width: 50px; height: 50px; border-radius: 8px; background: #eee; margin-right: 15px; overflow: hidden; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .inv-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .inv-thumb span { font-size: 1.5rem; }
        .inv-info { flex: 1; }
        .inv-name { font-weight: 600; font-size: 1rem; }
        .inv-date { font-size: 0.75rem; color: var(--text-sub); margin-top: 3px; }
        .use-btn { border: 1px solid var(--primary); background: transparent; color: var(--primary); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; }
        .used-tag { background: #eee; color: #aaa; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; }
        nav { position: fixed; bottom: 0; width: 100%; height: var(--nav-height); background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); display: flex; border-top: 1px solid #eee; z-index: 100; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #aaa; font-size: 0.7rem; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 4px; }
        #welcome-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        .gacha-machine { font-size: 6rem; margin-bottom: 20px; animation: bounce 2s infinite; }
        .welcome-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
        .welcome-desc { color: var(--text-sub); margin-bottom: 30px; line-height: 1.6; }
        .start-btn { background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: bold; box-shadow: 0 5px 20px rgba(0,0,0,0.2); cursor: pointer; transition: 0.2s; }
        .start-btn:active { transform: scale(0.95); }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

        /* --- ğŸ¡ è¼ªç›¤æ¨£å¼ --- */
        .wheel-container {
            width: 250px; height: 250px;
            background: conic-gradient(#d3d3d3 0% 25%, #e9e9e9 25% 50%, #d3d3d3 50% 75%, #e9e9e9 75% 100%);
            border-radius: 50%; margin: 20px auto; position: relative; border: 8px solid white; box-shadow: 0 0 0 5px #ccc; overflow: hidden; 
            transition: transform 4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .pointer {
            width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid var(--primary); 
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%); z-index: 5;
        }
        .sector-label {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; text-align: center; transform-origin: 50% 50%; 
        }
        .sector-text {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%) rotate(-90deg); font-size: 0.85rem; font-weight: 700; color: var(--text); width: 100px; 
        }
        .s1 { transform: rotate(45deg); } 
        .s2 { transform: rotate(135deg); } 
        .s3 { transform: rotate(225deg); }
        .s4 { transform: rotate(315deg); }

        /* --- ğŸª™ åˆ®åˆ®æ¨‚æ¨£å¼ (NEW) --- */
        #scratch-area {
            width: 250px;
            height: 120px;
            background: #eee;
            margin: 20px auto;
            border-radius: 15px;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        #scratch-result-display {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: bold;
            background: linear-gradient(135deg, #f0f0f0, #ffffff);
            border-radius: 15px;
            color: #d35400; /* é†’ç›®çš„æ©˜è‰² */
        }
        #scratch-cover {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #95a5a6; /* ç°è‰²è¦†è“‹å±¤ */
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

    </style>
</head>
<body>

    <div id="welcome-modal">
        <div class="gacha-machine" id="gacha-icon">ğŸ’Š</div>
        <div class="welcome-title">ç”Ÿæ—¥é»æ•¸æ‰­è›‹æ©Ÿ</div>
        <p class="welcome-desc">
            è¦ªæ„›çš„å¦å¦‚ç”Ÿæ—¥å¿«æ¨‚ï¼<br>
            ä½ å°‡éš¨æ©ŸæŠ½å‡ºè‡ªå·±çš„ç”Ÿæ—¥ç¦®ç‰©é»æ•¸ã€‚<br>
            (å€é–“ï¼š5000 ~ 7000é»)
        </p>
        <button class="start-btn" onclick="startGacha()">ç«‹å³æŠ½å–</button>
    </div>
    
    <div id="app-interface">
        <header>
            <div class="header-title">å¦å¦‚çš„è§£æ†‚é›œè²¨èˆ–~</div>
            <div class="points-box"><span id="points-display">0</span> P</div>
        </header>

        <div id="app-container">
            <div id="page-shop" class="page active">
                <h3 style="margin-top:0; color:var(--text-sub); font-size:0.9rem;">ç²¾é¸å…Œæ›é …ç›®</h3>
                <div class="grid" id="shop-grid"></div>
            </div>

            <div id="page-game" class="page">
                <div class="game-area" style="margin-bottom: 20px;">
                    <h2>âœ¨ å‘½é‹çš„è½‰ç›¤ (å€å¡Šä¸ä»£è¡¨æ©Ÿç‡ï¼Œä¸æœƒæ˜¯25%) âœ¨</h2>
                    <p class="game-desc">èŠ±è²»100é»ï¼Œæœ‰æ©Ÿæœƒç²å¾—é›™å€é»æ•¸ (ä½†æ©Ÿç‡å¾ˆä½)! </p>
                    
                    <div style="position: relative; width: 250px; margin: 0 auto;">
                        <div class="pointer"></div>
                        <div class="wheel-container" id="wheel">
                            <div class="sector-label s1"><span class="sector-text">é»æ•¸é›™å€</span></div>
                            <div class="sector-label s2"><span class="sector-text">ç²å¾—500é»</span></div>
                            <div class="sector-label s3"><span class="sector-text">å†ç©ä¸€æ¬¡</span></div>
                            <div class="sector-label s4"><span class="sector-text">å•¥éƒ½æ²’æœ‰ç¬‘æ­»</span></div>
                        </div>
                    </div>

                    <button class="spin-btn" id="spin-btn" onclick="playGame()">é–‹è½‰ (100é»)</button>
                    <p id="game-result" style="margin-top: 15px; height: 20px; font-weight: bold; color: var(--primary);"></p>
                </div>

                <div class="game-area" style="margin-top: 20px;">
                    <h2>ğŸª™ å¹¸é‹ä¸€ç•ªè³ ğŸª™</h2>
                    <p class="game-desc">æŠ½ä¸€å¼µèŠ±è²»200é»ï¼Œè©¦è©¦æ‰‹æ°£å§ (è‡‰é»‘)ï¼</p>
                    
                    <div id="scratch-area">
                        <div id="scratch-result-display"></div>
                        <button id="scratch-cover" onclick="revealScratch()">é‚„æ•¢æŠ½ä¸€ç•ªè³å–”?</button>
                    </div>

                    <button class="spin-btn" id="scratch-btn" onclick="startScratch()" style="margin-top: 20px;">æŠ½ä¸€ä¸‹ (200é»)</button>
                    <p id="scratch-msg" style="margin-top: 15px; height: 20px; font-weight: bold; color: var(--primary);"></p>
                </div>
            </div>

            <div id="page-inventory" class="page">
                <h3 style="margin-top:0; color:var(--text-sub); font-size:0.9rem;">æˆ‘çš„èƒŒåŒ…</h3>
                <div id="inventory-list"></div>
                <div id="empty-msg" style="text-align:center; color:#ccc; margin-top:50px;">ç›®å‰ç©ºç©ºå¦‚ä¹Ÿ</div>
                <button onclick="resetAll()" style="margin-top:50px; border:none; background:none; color:#ddd; width:100%;">[Reset Data]</button>
            </div>
        </div>

        <nav>
            <div class="nav-item active" onclick="switchPage('shop', this)">
                <span class="nav-icon">ğŸ›ï¸</span>
                <span>é¸ç‰©å€</span>
            </div>
            <div class="nav-item" onclick="switchPage('game', this)">
                <span class="nav-icon">ğŸ¡</span>
                <span>éŠæˆ²å€</span>
            </div>
            <div class="nav-item" onclick="switchPage('inventory', this)">
                <span class="nav-icon">ğŸ’</span>
                <span>èƒŒåŒ…</span>
            </div>
        </nav>
    </div>

<script>
    // --- âš™ï¸ è¨­å®šå€ ---
    
    const MIN_P = 5000;
    const MAX_P = 7000;
    const STORAGE_VERSION = 'v70'; // æ›´æ–°å„²å­˜ç‰ˆæœ¬è™Ÿè‡³ V7.0 (å¼·åˆ¶é‡ç½®èˆŠç‰ˆè³‡æ–™ï¼Œä»¥é˜²å–®æ¬¡å…Œæ›åˆ¤æ–·å‡ºéŒ¯)

    // --- å•†å“æ¸…å–® (V7.0 - å¢åŠ å–®æ¬¡å…Œæ›æ——æ¨™) ---
    const products = [
        { 
            id: 1, name: "ç”Ÿæ—¥ç´…åŒ… (è«‹æˆªåœ–å…Œæ›)", price: 1200, emoji: "ğŸ§§", 
            isRandomReward: true, rewardRange: [1022, 1206], 
            image: "https://img.91app.com/webapi/imagesV3/Original/SalePage/10431013/0/638722265015070000?v=1",
            isOneTimePurchase: true // <--- NEW: é™åˆ¶å–®æ¬¡å…Œæ›
        },
        { 
            id: 2, name: "Samba OG (ä»»é¸è‰²)", price: 5000, emoji: "ğŸ‘Ÿ", 
            image: "https://img.shoplineapp.com/media/image_clips/642a83cfc16553001adb82e9/original.jpg?1680507855",
            isOneTimePurchase: true // <--- NEW: é™åˆ¶å–®æ¬¡å…Œæ›
        },
        { 
            id: 3, name: "Dinotaengå…¬ä»”&å¨ƒå¨ƒ (ä»»é¸)", price: 1200, emoji: "ğŸ§¸", 
            image: "https://img.91app.com/webapi/imagesV3/Original/SalePage/9124784/0/638737800477000000?v=1",
            isOneTimePurchase: true // <--- NEW: é™åˆ¶å–®æ¬¡å…Œæ›
        },
        { 
            id: 4, name: "ç£å¸å¡å¥—", price: 800, emoji: "ğŸ’³", 
            image: "https://encrypted-tbn2.gstatic.com/shopping?q=tbn:ANd9GcQ4_2qe8MQjrIcHzObsvyhAx8IPe0zJMQwVl1VbkM_QqXELzydM5dKzcoSduDmZ9LStCKEt-blGjJq799qUQIV5eoH0naJsWBlMW6xekf30-bZEULYXAcDcfqbpPFhhmtTCiIccOMI&usqp=CAc",
            isOneTimePurchase: true // <--- NEW: é™åˆ¶å–®æ¬¡å…Œæ›
        },
        { 
            id: 5, name: "Dinotaengå®‰å…¨å¸½", price: 2000, emoji: "â›‘ï¸", 
            image: "https://shoplineimg.com/625cd9cb8f7c6200691ed3d8/67035a203d3e2b0010fa2ebc/3860x.jpg?",
            isOneTimePurchase: true // <--- NEW: é™åˆ¶å–®æ¬¡å…Œæ›
        },
    ];

    // --- ğŸš€ ç¨‹å¼é‚è¼¯ ---
    let points = 0;
    let inventory = [];
    let isSpinning = false;
    let currentScratchPrize = null; // å„²å­˜åˆ®åˆ®æ¨‚çµæœçš„ç‰©ä»¶

    function init() {
        // *** æ³¨æ„ï¼šç”±æ–¼ä¿®æ”¹äº† STORAGE_VERSIONï¼ŒèˆŠè³‡æ–™æœƒè¢«æ¸…ç©ºï¼Œè«‹é‡æ–°æŠ½å–é»æ•¸ ***
        const hasStarted = localStorage.getItem('gf_has_started_' + STORAGE_VERSION);
        const appInterface = document.getElementById('app-interface');
        
        if (hasStarted) {
            document.getElementById('welcome-modal').style.display = 'none';
            appInterface.style.display = 'flex';
            loadData();
        } else {
            appInterface.style.display = 'none';
        }
        // ç¢ºä¿åˆ®åˆ®æ¨‚åˆå§‹ç‹€æ…‹æ­£ç¢º
        resetScratchCard();
    }

    // NEW: æª¢æŸ¥å–®æ¬¡å…Œæ›å•†å“æ˜¯å¦å·²å­˜åœ¨æ–¼èƒŒåŒ…ä¸­
    function checkIfPurchased(id) {
        const item = products.find(p => p.id === id);
        if (!item) return false;
        
        // æª¢æŸ¥èƒŒåŒ…è£¡æ˜¯å¦æœ‰æ­¤å•†å“çš„ç´€éŒ„ã€‚
        // æˆ‘å€‘ç”¨å•†å“çš„åŸå§‹åç¨±ä¾†éæ¿¾ï¼Œå› ç‚ºç´…åŒ…æœƒè¢«åŠ ä¸Šç²å¾—çš„é»æ•¸ã€‚
        const boughtCount = inventory.filter(invItem => invItem.name.includes(item.name)).length;
        
        // åªè¦è³¼è²·è¨ˆæ•¸å¤§æ–¼ 0ï¼Œå°±ä»£è¡¨å·²ç¶“å…Œæ›é
        return boughtCount > 0;
    }

    window.startGacha = function() {
        const btn = document.querySelector('.start-btn');
        const icon = document.getElementById('gacha-icon');
        
        btn.disabled = true;
        btn.innerText = "æŠ½å–ä¸­...";
        icon.classList.remove('bounce');
        icon.classList.add('shake');

        setTimeout(() => {
            const step = 100;
            const stepsCount = (MAX_P - MIN_P) / step;
            const randomStep = Math.floor(Math.random() * (stepsCount + 1));
            const finalPoints = (randomStep * step) + MIN_P;

            points = finalPoints;
            localStorage.setItem('gf_points_' + STORAGE_VERSION, points);
            localStorage.setItem('gf_has_started_' + STORAGE_VERSION, 'true');
            
            alert(`âœ¨ å®å’šï¼âœ¨\næ­å–œå¦³ç²å¾—ç”Ÿæ—¥ç¦®é‡‘ï¼š\n\nğŸ’° ${finalPoints} P\n\nå¿«å»é€›é€›å§ï¼`);
            
            document.getElementById('welcome-modal').style.display = 'none';
            document.getElementById('app-interface').style.display = 'flex';
            updateUI();
            renderShop();

        }, 1500);
    }
    
    function loadData() {
        const savedPoints = localStorage.getItem('gf_points_' + STORAGE_VERSION);
        const savedInv = localStorage.getItem('gf_inventory_' + STORAGE_VERSION);
        
        if (savedPoints) points = parseInt(savedPoints);
        points = points || 0; 

        if (savedInv) inventory = JSON.parse(savedInv);
        
        updateUI();
        renderShop();
        renderInventory();
    }

    function saveData() {
        localStorage.setItem('gf_points_' + STORAGE_VERSION, points);
        localStorage.setItem('gf_inventory_' + STORAGE_VERSION, JSON.stringify(inventory));
        updateUI();
    }

    function updateUI() {
        document.getElementById('points-display').innerText = points;
        renderShop(); 
    }

    // --- ğŸ›ï¸ å•†åº—æ¸²æŸ“èˆ‡è³¼è²·é‚è¼¯ (åŠ å…¥å–®æ¬¡å…Œæ›æª¢æŸ¥) ---
    function renderShop() {
        const grid = document.getElementById('shop-grid');
        grid.innerHTML = '';
        
        products.forEach(p => {
            const minCost = p.price;
            
            // --- NEW: å–®æ¬¡å…Œæ›ç‹€æ…‹æª¢æŸ¥ ---
            const isOneTime = p.isOneTimePurchase;
            const alreadyBought = isOneTime && checkIfPurchased(p.id);

            // æœ€çµ‚è³¼è²·æ¢ä»¶ï¼šé»æ•¸è¶³å¤  ä¸” (ä¸æ˜¯å–®æ¬¡é™åˆ¶ æˆ– å°šæœªå…Œæ›)
            const canBuy = points >= minCost && !alreadyBought; 

            // æ±ºå®šæŒ‰éˆ•æ–‡å­—
            let buttonText = 'å…Œæ›';
            if (alreadyBought) {
                buttonText = 'å·²å…Œæ› (å–®æ¬¡é™åˆ¶)';
            } else if (!canBuy && !alreadyBought) {
                buttonText = 'é¤˜é¡ä¸è¶³ (ç„¡æ³•å„²å€¼)';
            } else if (!canBuy) {
                buttonText = 'ä½ æ²’éŒ¢äº† (ç„¡æ³•å„²å€¼)';
            }
            
            let priceHtml = '';
            if (p.isRandomReward) {
                // ç´…åŒ…é‚è¼¯ï¼šèŠ±è²»å›ºå®šé»æ•¸ï¼Œç²åˆ©éš¨æ©Ÿé‡‘é¡
                priceHtml = `<div class="card-price">${p.price} P</div>`;
            } else {
                priceHtml = `<div class="card-price">${p.price} P</div>`;
            }
            
            let imageHtml = (p.image && p.image.length > 0) 
                ? `<img src="${p.image}" class="card-img" alt="${p.name}">`
                : `<span class="card-emoji">${p.emoji}</span>`;

            grid.innerHTML += `
                <div class="card">
                    <div class="card-img-box">${imageHtml}</div>
                    <div class="card-body">
                        <div>
                            <div class="card-title">${p.name}</div>
                            ${priceHtml}
                        </div>
                        <button class="buy-btn" onclick="buy(${p.id})" ${canBuy ? '' : 'disabled'}>
                            ${buttonText}
                        </button>
                    </div>
                </div>
            `;
        });
    }

    window.buy = function(id) {
        const item = products.find(p => p.id === id);
        
        // --- NEW: å…Œæ›å–®æ¬¡é™åˆ¶æª¢æŸ¥ (é˜²æ­¢ç¹é UI) ---
        if (item.isOneTimePurchase && checkIfPurchased(id)) {
            alert(`ã€Œ${item.name}ã€æ˜¯å–®æ¬¡å…Œæ›å•†å“ï¼Œå¦³å·²ç¶“å…Œæ›éäº†å–”ï¼`);
            renderShop(); // å¼·åˆ¶æ›´æ–°UI
            return; // çµ‚æ­¢è³¼è²·
        }

        if (item.isRandomReward) {
            if (points >= item.price) {
                if (confirm(`ç¢ºå®šèŠ±è²» ${item.price} P å…Œæ›ã€Œ${item.name}ã€å—ï¼Ÿ`)) {
                    
                    points -= item.price; 
                    
                    const MIN_R = item.rewardRange[0];
                    const MAX_R = item.rewardRange[1];
                    const finalReward = Math.floor(Math.random() * (MAX_R - MIN_R + 1)) + MIN_R;
                    
                    points += finalReward;
                    
                    inventory.push({
                        id: Date.now(),
                        name: `${item.name}`, // ç´…åŒ…åç¨±ä¸å†æ·»åŠ é»æ•¸ï¼Œç¢ºä¿ checkIfPurchased èƒ½æ­£ç¢ºæ¯”å°
                        emoji: item.emoji,
                        image: item.image,
                        date: new Date().toLocaleDateString(),
                        used: false,
                        reward: finalReward // å°‡é»æ•¸ä½œç‚ºæ–°å±¬æ€§å„²å­˜ï¼Œç”¨ä¾†å±•ç¤º
                    });
                    saveData();
                    renderInventory();
                    alert(`ğŸŠ å…Œæ›æˆåŠŸï¼æœ¬æ¬¡èŠ±è²» ${item.price} Pï¼Œç²å¾—éš¨æ©Ÿé‡‘é¡ ${finalReward} Pï¼`);
                }
            } else {
                alert(`ä½ çš„é»æ•¸ (${points} P) ä¸å¤ èŠ±è²» ${item.price} P å…Œæ›ç´…åŒ… ğŸ¥º`);
            }

        } 
        else if(points >= item.price) {
            if(confirm(`ç¢ºå®šå…Œæ›ã€Œ${item.name}ã€å—ï¼Ÿ`)) {
                points -= item.price;
                inventory.push({
                    id: Date.now(),
                    name: item.name,
                    emoji: item.emoji,
                    image: item.image,
                    date: new Date().toLocaleDateString(),
                    used: false
                });
                saveData();
                renderInventory();
                alert("å·²æ”¾å…¥èƒŒåŒ…ï¼ğŸ’");
            }
        } else {
             // é»æ•¸ä¸è¶³çš„ alert
        }
    }
    
    // --- ğŸ¡ è¼ªç›¤éŠæˆ²é‚è¼¯ (èˆ‡ V5.0 ç›¸åŒ) ---
    window.playGame = function() {
        if (isSpinning) return;
        if (points < 100) {
            alert("é»æ•¸ä¸å¤  100 Pï¼Œç„¡æ³•å•Ÿå‹•è¼ªç›¤ ğŸ¥º");
            return;
        }

        points -= 100;
        saveData();

        isSpinning = true;
        const wheel = document.getElementById('wheel');
        const resultText = document.getElementById('game-result');
        const btn = document.getElementById('spin-btn');
        
        resultText.innerText = "è½‰å‹•ä¸­...";
        btn.disabled = true;

        const rand = Math.random();
        let outcome; 
        let prizeName;
        
        // è¼ªç›¤æ©Ÿç‡ (V5.0): 5%(é›™å€), 20%(500P), 35%(é€€100P), 40%(éŠ˜è¬)
        if (rand < 0.05) { outcome = 3; prizeName = "ğŸ’ è¶…ç´šå¹¸é‹ï¼šé»æ•¸ç¿»å€ï¼"; } 
        else if (rand < 0.25) { outcome = 0; prizeName = "ğŸ‰ é‹æ°£ä¸éŒ¯ï¼šç²å¾— 500 é»ï¼"; }
        else if (rand < 0.6) { outcome = 2; prizeName = "ğŸ˜Š å†ç©ä¸€æ¬¡"; }
        else { outcome = 1; prizeName = "ğŸ˜… è¶…ç´šå¯æ†ï¼šå•¥éƒ½æ²’æœ‰ç¬‘æ­»"; } 

        const baseSpin = 1080 + Math.floor(Math.random() * 360); 
        wheel.style.transform = `rotate(${baseSpin}deg)`;

        setTimeout(() => {
            isSpinning = false;
            btn.disabled = false;
            resultText.innerText = prizeName;
            
            if (outcome === 0) points += 500;
            if (outcome === 2) points += 100;
            if (outcome === 3) points = points * 2;
            
            saveData();
            
            if(outcome === 3 || outcome === 0) {
                alert(`å¤ªç¥å•¦ï¼\n${prizeName}`);
            }
            
            setTimeout(() => {
                // é‡ç½®è¼ªç›¤è§’åº¦
                wheel.style.transition = 'none';
                wheel.style.transform = 'rotate(0deg)';
                setTimeout(() => {
                    wheel.style.transition = 'transform 4s cubic-bezier(0.2, 0.8, 0.2, 1)';
                }, 50); 
            }, 500);

        }, 4000);
    };

    // --- ğŸª™ åˆ®åˆ®æ¨‚éŠæˆ²é‚è¼¯ (NEW: V6.0) ---

    // é‡ç½®åˆ®åˆ®æ¨‚å¡ç‰‡ç‹€æ…‹
    function resetScratchCard() {
        const resultDisplay = document.getElementById('scratch-result-display');
        const scratchCover = document.getElementById('scratch-cover');
        const resultMsg = document.getElementById('scratch-msg');
        const btn = document.getElementById('scratch-btn');

        currentScratchPrize = null;
        resultDisplay.style.display = 'none';
        scratchCover.style.display = 'block';
        scratchCover.innerText = 'é‚„æ•¢æŠ½ä¸€ç•ªè³å–”?';
        resultMsg.innerText = '';
        btn.disabled = false;
        btn.innerText = 'æŠ½ä¸€ä¸‹ (200é»)';
    }

    // é–‹å§‹åˆ®åˆ®æ¨‚ (é»æ“Šä¸‹æ–¹æŒ‰éˆ•)
    window.startScratch = function() {
        const scratchCover = document.getElementById('scratch-cover');
        const resultMsg = document.getElementById('scratch-msg');
        const btn = document.getElementById('scratch-btn');

        if (points < 200) {
            alert("é»æ•¸ä¸å¤  200 Pï¼Œç„¡æ³•åˆ®å¡ ğŸ¥º");
            return;
        }

        // 1. æ‰£é™¤é»æ•¸ä¸¦é–å®š
        points -= 200;
        saveData();
        btn.disabled = true;
        btn.innerText = 'ç©¶ç«Ÿæœ‰æ²’æœ‰å¾—çå‘¢...';
        
        resultMsg.innerText = 'ç­‰å¾…çµæœæ­æ›‰...';

        // 2. æ±ºå®šçé …
        const rand = Math.random();
        let prizeName, pointsChange;
        
        // æ©Ÿç‡åˆ†ä½ˆè¨­å®š: 10%(500P), 20%(é€€200P), 30%(100P), 40%(éŠ˜è¬)
        if (rand < 0.1) {
            prizeName = "ç²å¾— 500 é»";
            pointsChange = 500;
        } else if (rand < 0.3) { 
            prizeName = "å†ç©ä¸€æ¬¡"; // é€€é‚„ 200 P
            pointsChange = 200;
        } else if (rand < 0.6) {
            prizeName = "ç²å¾— 100 é»";
            pointsChange = 100;
        } else {
            prizeName = "éŠ˜è¬æƒ é¡§";
            pointsChange = 0;
        }

        currentScratchPrize = { name: prizeName, change: pointsChange };

        // 3. æº–å‚™åˆ®é–‹å¡ç‰‡
        const resultDisplay = document.getElementById('scratch-result-display');
        resultDisplay.style.display = 'none';
        scratchCover.style.display = 'block';
        scratchCover.innerText = 'é»æ“Šåˆ®é–‹';
    };

    // æ­æ›‰åˆ®åˆ®æ¨‚çµæœ (é»æ“Šå¡ç‰‡)
    window.revealScratch = function() {
        const resultDisplay = document.getElementById('scratch-result-display');
        const scratchCover = document.getElementById('scratch-cover');
        const resultMsg = document.getElementById('scratch-msg');
        const btn = document.getElementById('scratch-btn');

        if (!currentScratchPrize) {
             // é¿å…åœ¨æœªé–‹å§‹éŠæˆ²æ™‚é»æ“Š
             alert("è«‹å…ˆé»æ“Šä¸‹æ–¹çš„ã€ŒæŠ½ä¸€ä¸‹ã€æŒ‰éˆ•é–‹å§‹éŠæˆ² ğŸ‘†");
             return;
        }
        
        const { name, change } = currentScratchPrize;

        // 1. æ›´æ–°é»æ•¸
        points += change;
        saveData();

        // 2. é¡¯ç¤ºçµæœ
        resultDisplay.innerText = name;
        resultDisplay.style.display = 'flex';
        scratchCover.style.display = 'none';
        resultMsg.innerText = `çµæœï¼š${name}ï¼`;
        
        // 3. å½ˆçª—é€šçŸ¥
        if (change >= 500) {
            alert(`åˆ®å‡ºå¤§çï¼ğŸ‰\nå¦³ç²å¾—äº† ${change} é»ï¼`);
        } else if (change > 0) {
            alert(`æœ‰çï¼ğŸ‰\nå¦³ç²å¾—äº† ${change} é»ï¼`);
        } else {
            alert(`çµæœï¼š${name} ğŸ¥ºï¼Œæ‰¾ç”·å‹å“­å“­`);
        }

        // 4. é‡ç½®ç‹€æ…‹
        // æ³¨æ„ï¼šé€™è£¡çš„ resetScratchCard() æ‡‰è©²åœ¨ alert å¾ŒåŸ·è¡Œï¼Œç¢ºä¿ç©å®¶çœ‹åˆ°çµæœ
        setTimeout(resetScratchCard, 500); 
    };

    // --- ğŸ’ èƒŒåŒ…æ¸²æŸ“èˆ‡ä½¿ç”¨ / é é¢åˆ‡æ› / é‡ç½®é‚è¼¯ (èˆ‡ V5.0 ç›¸åŒ) ---
    function renderInventory() {
        const list = document.getElementById('inventory-list');
        list.innerHTML = '';
        
        if(inventory.length === 0) {
            document.getElementById('empty-msg').style.display = 'block';
            return;
        }
        document.getElementById('empty-msg').style.display = 'none';

        [...inventory].reverse().forEach(item => {
            let thumbHtml = (item.image) ? `<img src="${item.image}">` : `<span>${item.emoji}</span>`;
            
            // é‡å°ç´…åŒ…ç‰¹åˆ¥é¡¯ç¤ºç²å¾—çš„é»æ•¸
            const itemName = item.reward 
                ? `${item.name.replace(' (è«‹æˆªåœ–å…Œæ›)', '')} (ç²å¾— ${item.reward} P)` 
                : item.name;

            list.innerHTML += `
                <div class="inventory-item" style="opacity: ${item.used ? 0.5 : 1}">
                    <div class="inv-thumb">${thumbHtml}</div>
                    <div class="inv-info">
                        <div class="inv-name">${itemName}</div>
                        <div class="inv-date">${item.date}</div>
                    </div>
                    ${item.used 
                        ? '<span class="used-tag">å·²å…Œæ›</span>' 
                        : `<button class="use-btn" onclick="useItem(${item.id})">ä½¿ç”¨</button>`
                    }
                </div>
            `;
        });
    }

    window.useItem = function(uid) {
        if(confirm("ç¢ºå®šè¦ç¾åœ¨æ ¸éŠ·é€™å¼µåˆ¸å—ï¼Ÿ(é€™å‹•ä½œä¸å¯é€†)")) {
            const item = inventory.find(i => i.id === uid);
            if(item) {
                item.used = true;
                saveData();
                renderInventory();
                alert("âœ… æ ¸éŠ·æˆåŠŸï¼è«‹äº«å—å¦³çš„ç¦®ç‰© (ä½ ç”·å‹å¥½è¾›è‹¦)ï¼");
            }
        }
    }

    window.switchPage = function(pageName, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageName).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function resetAll() {
        if(confirm("âš ï¸ è­¦å‘Šï¼šé€™æœƒæ¸…é™¤æ‰€æœ‰ç´€éŒ„å›åˆ°åˆå§‹ç‹€æ…‹ï¼")) {
            localStorage.removeItem('gf_points_' + STORAGE_VERSION);
            localStorage.removeItem('gf_inventory_' + STORAGE_VERSION);
            localStorage.removeItem('gf_has_started_' + STORAGE_VERSION);
            location.reload();
        }
    }

    init();
</script>
</body>
</html>

